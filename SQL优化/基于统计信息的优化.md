#### SQL 优化基础

##### 基数与选择性

某个列唯一键的个数叫做这个列的基数，如果这个值与总行数的比值越大，表示选择性越好。如果数据分布不均，建议使用全表扫描，而不是使用索引。

SQL优化必须具有以下条件:

1. 必须是大表，小表即使是全表扫描，对性能也不会产生过大的影响
2. 选择必须需要创建索引的列，该列必须出现在where条件中，同时不能参与表达式，函数运算. 
3. 最好使用覆盖索引，不使用覆盖索引，则会通过回表查找数据行信息，对于范围查找开销较大。    

##### 直方图

如果某个列的选择性低，则数据分布的不均衡，但是优化器(CBO)默认是按照数据分布均匀的方式对执行计划进行优化的，则也就会导致执行计划跑偏。所以，对于分布不均衡的列，需要收集直方图信息，有了数据分布的直方图，CBO会按照直方图的信息去优化执行计划，这样就不会跑偏了。(直方图会将数据分布情况，记录在数据字典中，而CBO会优先查看数据字典中是否有数据分布情况，如果有则按照这个数据分布执行)。

当然，对不在where条件中的字段作直方图是毫无意义的，且会消耗系统资源。

##### 回表

索引结构中，通常包含索引值和当前值所在行的row_id. 如果需要查找满足当前索引条件的行数据信息(或者其他字段信息). 则需要进行回表查询，查询到row_id，然后把行数据读取到缓冲区中。

如果回表次数过多，那么查询性能会低于全表扫描，尤其是在大范围的范围查询，回表次数会很多，造成的磁盘IO很多, 且大多数随机IO. 

##### 集群因子

集群因子用于判断索引回表需要消耗的物理IO次数.

索引因子表示记录所占有的数据块数量，这个数量最大为数据表的行数，最小为数据块的数量。

+ 如果这个值接近于数据块的数量，那么数据基本有序，进行索引扫描或者全扫描的时候，只需要信息少量的读取操作即可。
+ 如果这个值接近于数据表的行数，那么扫描的时候会读取更多的数据块。

集群因子只会影响索引范围扫描和索引全扫描，只有这两个操作有大量回表存在。

当然可以设计覆盖索引，来解决回表的问题。



#### 统计信息

只有大表才会产生性能问题，那么怎么才能让优化器知道某个表多大呢？

基数，直方图，集群因子需要通过收集统计信息得到，如果没有正确地收集表的统计信息，或者没有及时地更新表的统计信息，SQL的执行计划就会跑偏，SQL也就会出现性能问题。

统计信息主要分为表的统计信息、列的统计信息、索引的统计信息、系统的统计信息、数据字典的统计信息以及动态性能视图基表的统计信息。这里我们只讨论前三者。

1. 表统计信息
2. 列统计信息
   - 列的基数
   - 列的空值数量
   - 列的数据分布(直方图)
3. 索引统计信息
   + 叶子块个数
   + 集群因子
   + 索引`blevel`



##### 统计信息过期带来的问题与解决方案

收集完表的统计信息之后，如果表中有大量数据发生变化，这时表的统计信息就过期了，我们需要重新收集表的统计信息，如果不重新收集，可能会导致执行计划走偏。

Oracle是怎么判断一个表的统计信息过期了呢？当表中有超过10%的数据发生变化（INSERT，UPDATE，DELETE），就会引起统计信息过期。

数据字典all_tab_modifications还可以用来判断哪些表需要定期 降低高水位，比如一个表经常进行insert、delete，那么这个表应该定期降低高水位，这个表的索引也应该定期重建。all_tab_modifications还可以用来判断系统中哪些表是业务核心表、表的数据每天增长量等。



##### 扩展统计信息

当where条件中有多个谓词过滤条件，但是这些谓词过滤条件彼此是**有关系**的而不是相互独立的，这时我们可能需要收集扩展统计信息以便优化器能够估算出较为准确的行数。

需要注意的是，扩展统计信息只能用于等值查询，不能用于非等值查询。



##### 动态采样

如果一个表从来没收集过统计信息，默认情况下Oracle会对表进行动态采样（Level=2）以便优化器估算出较为准确的Rows，动态采样的最终目的就是为了让优化器能够评估出较为准确的Rows。



当系统中有全局临时表，就需要使用动态采样，因为全局临时表无法收集统计信息，我们建议对全局临时表至少启用level 4进行采样



当执行计划中表的Rows估算有严重偏差的时候，例如相关列问题，或者两表关联有多个连接列，关联之后Rows算少，或者是where过滤条件中对列使用了substr、instr、like，又或者是where过滤条件中有非等值过滤，或者group by之后导致Rows估算错误，此时我们可以考虑使用动态采样，建议动态采样至少设置为level 4。



> 例如:
>
> 在数据仓库系统中，有些报表SQL是采用Obiee/SAP BO/Congnos自动生成的，此类SQL一般都有几十行甚至几百行，SQL的过滤条件一般也比较复杂，有大量的AND和OR过滤条件，同时也可能有大量的where子查询过滤条件，SQL最终返回的数据量其实并不多.
>
> 
>
> 对于此类SQL，如果SQL执行缓慢，有可能是因为SQL的过滤条件太复杂，从而导致优化器不能估算出较为准确的Rows而产生了错误的执行计划。我们可以考虑启用动态采样level 6观察性能是否有所改善，我们曾利用该方法优化了大量的报表SQL。



