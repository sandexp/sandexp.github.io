#### 记录的组织方式

关系是记录的集合，给定一个记录的集合之后，我们就得去研究如何去组织它们。

通常情况下，有如下几种组织方式:

1. 堆文件组织

   一条记录可以放置在文件中的任何地方。记录是没有顺序的，通常一个关系使用一个单独的文件。

   为了对页中的记录进行检索，必须支持对堆文件中记录的迭代访问。且需要使用元数据记录哪些数据页存在，且哪个数据页有空闲空间。

2. 顺序文件组织

   根据搜索码的值顺序存储

3. 散列文件组织

   根据每条记录的某些属性计算一个散列函数，散列函数的结果确定放置到文件的哪个块中。

#### 堆文件结构

堆文件有两种实现方式

1. 链表(双链表)

对于堆文件的结构来说，需要维护一个header页，用于存储堆的起始地址信息(包括已使用的数据和未分配的数据)。结构如下:

每个数据页都会追踪自己页中空闲槽的数量。

2. 页目录

DBMS中设计一个目录结构，用于记录数据页的位置信息。这个时候每个数据页的空槽数量是记录在目录中的。

DBMS必须要保证目录页和实际数据页的一致性。结构如下:



#### 数据页的结构

每个数据页包括了元数据的头部信息，以及数据信息。

> 1. 页大小
> 2. 校验和信息
> 3. DBMS版本信息
> 4. 事务可见性
> 5. 数据压缩信息

结构如下:



##### 数据部分的布局

那么数据部分又该如何进行存储布局呢？我们提供两种方式进行布局，一种是基于元组的布局，另一种是基于日志的布局。

##### 基于元组的存储布局

1. 对于无变长记录的情况下

   可以通过记录号*记录长度的方式，对记录进行迭代访问。

2. 记录如何删除?

   可以通过设计标记删除的位(`isDeleted`), 或者也可以设置一个int类型值，设定特点的比特位来标记删除标志。最后，物理删除交给后台的`GC`线程处理. 例如PG的vacuum。

3. 如何支持变长记录

   首先变长记录必须在记录首部表示当前记录的长度，那么这种情况下，记录就只能够顺序的迭代访问了。这里，我们在页的头部信息中，新建一个slot槽数组，每个槽中的元组指向第N条记录的物理地址。这样第二次访问的时候，就可以直接通过数组下标进行访问了。如图:

   

##### 基于日志的存储布局





