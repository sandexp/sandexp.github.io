#### 备份与恢复概述

备份包括如下几种类型：

+ 热备份
+ 冷备份
+ 温备份

热备份指的是在数据库运行时进行备份，对运行的数据库没有影响。

冷备份指的是在数据库停止的情况下进行备份，这种备份最简单，一般只需要拷贝相关数据库文件即可。

温备份同样是在数据库中进行，但是会对数据库操作有影响。



按照备份后文件的内容，可以分为：

+ 逻辑备份
+ 裸文件备份

逻辑备份指的是备份后文件时可读的，通常是文本文件，内容一般是SQL语句或者是表内的实际数据。可以使用`select * into outfile`的方法,这类方法可以看到导出后的文件内容,一般适用于数据库的升级,迁移等工作,但是恢复的时间也需要很长.

裸文件备份指的是拷贝数据库的物理文件,数据库既可以处于运行状态,也可以处于停止状态.这类备份的恢复事件较短.



按照备份数据库的内容,可以分为:

+ 完全备份

  对数据库进行完整备份

+ 增量备份

  在完整备份基础上,对更新数据进行备份

+ 日志备份

  通过对一个完整备份进行二进制日志的重做,完成数据库的恢复工作.

#### 冷备份

InnoDB存储引擎的冷备份只需要对mysql数据库frm文件,共享表空间文件,独立表空间文件(`*.ibd`)和重做日志文件.建议定期备份mysql数据库配置文件`my.cnf`

> 冷备份的优点:
>
> + 备份简单,只需要拷贝相关文件即可
> + 备份文件易于在不同操作系统,不同mysql版本上恢复
> + 恢复相当简单,只要把文件恢复到指定位置即可
> + 恢复速度块,不需要执行sql,也不需要重建索引
>
> 冷备份的缺点:
>
> + 冷备份的文件比逻辑文件大很多,主要是存储了其他类型的数据
> + 冷备份并不是总可以跨平台

#### 逻辑备份

+ `select ... into outfile`进行逻辑备份

  ```sql
  select [col1] [col2]... 
  into
  outfile 'file_name'
  ...
  ```

  默认导出时按照TAB分割的
  
+ 逻辑备份的恢复

  mysqldump的恢复方式比较简单,因为备份的文件就是导出的sql语句,一般只要执行这个文件就可以了

  ```shell
  mysql -uroot -p < test_backup.sql
  ```

+ `LOAD DATA INFILE`

  若是通过`mysqldump -tab`或者`select into outfile`导出的数据需要恢复的时候,需要`load data infile`进行导入.

  ```sql
  load data [LOW_PRIORITY | CURRENT] [LOCAL] INFILE 'file_name'
  ...
  ```

+ `mysqlimport`

  mysqlimport是一个musql数据库提供的命令行程序,本质上来说`load data infile`是一个命令接口,大多数选项都和`load data infile`相同,格式如下:

  ```shell
  $ mysqlimport [options] db_name textfile [textfile2 ...]
  ```

  这里注意到的是这个指令可以导入多张表,并且通过`--user-thread`参数并发导入不同文件.

#### 二进制日志备份与恢复

二进制日志非常关键,可以通过它完成point-in-time的恢复工作.mysql数据库复制同样需要二进制日志.需要自己其他二进制日志.

```shell
[mysqld]
log-bin
sync_binlog=1
innodb_support_xa=1
```

备份二进制文件前,可以通过FLUSH LOGS命令生成新的二进制文件,然后备份之前的二进制文件.

#### 热备份

+ `ibbackup`

  这个是官方提供的热备份工具,备份原理如下:

  + 记录备份开始时,innodb重做日志检查点LSN
  + 拷贝共享表空间文件以及独立表空间文件
  + 记录拷贝完表空间文件后,innoDB存储引擎重做日志文件检查点LSN
  + 拷贝在备份时产生重做日志

  > `ibbackup`优势:
  >
  > + 在线备份
  > + 备份性能好
  > + 支持压缩备份
  > + 跨平台支持

+ `XtraBackup`

  这个不仅可以实现热备份,还可以支持InnoDB的增量备份,工作原理:

  + 首先完成一个完全备份，并记录此时的检查点LSN
  + 在进行增量备份时，比较表空间每个页的LSN是否大于上次的LSN，如果是，则备份该页，同时记录当前检查点的LSN

#### 快照备份

mysql数据库本身不支持快照功能，因此快照备份指的是通过文件系统支持快照，从而对数据库进行备份。

备份的前提是将数据库文件放在同一个文件分区中，然后对分区执行快照。支持快照的文件系统包括UFS,ZFS,LVM等。

LVM是linux系统对磁盘分区进行管理的机制，lvm在硬盘和分区上建立一个逻辑层，来提高分区管理的灵活性。管理员可以通过LVM系统进行磁盘管理。

LVM使用了**写时复制**（Cow）创建快照。当创建一个快照的时候，仅仅拷贝原始卷里的元数据，并不会有数据的物理操作，因此快照的创建过程非常快。

> 当快照创建完成之后，原始卷上有写操作的时候，快照会跟踪原始卷的改变，将改变的数据在改变之前，拷贝到预留空间，因此叫做写时复制。

#### 复制

复制时mysql数据库的一种高可用，高性能解决方案，一般用于建立大型的应用。主要分为下述三个步骤：

+ 主服务器把数据更新记录到二进制日志中
+ 从服务器把主服务器的二进制日志拷贝到自己的中继日志中
+ 从服务器重做中继日志中的时间，把更新应用到自己的数据库上

主从服务器的操作是实时进行的,由于是异步所以会有一点的延时.

从服务器有两个线程,一个时IO线程,负责读取主服务器的二进制日志,将其保存为中继日志.另一个是SQL线程,复制执行的中继日志;另一个是SQL线程,复制执行中继日志.

<img src="E:\截图文件\主从复制原理.png" style="zoom:67%;" />

+ 快照复制的备份架构

  复制可以用来备份,但是功能不仅仅于备份,主要功能如下:

  + 数据分布

    由于mysql数据库提供的复制不需要很大的带宽,因此可以在不同数据中心之间实现数据拷贝

  + 读取的负载平衡

    通过建立多个从服务器,可以平均地分布到这些服务器中,从而减少主服务器压力,一般通过DNS的Round-Robin和linux的LVS功能实现负载均衡.

  + 数据库备份

    复制对备份很有帮助,但是服务器不是备份,也不能完全替代备份

  + 高可用和故障迁移

    通过复制建立的从服务器有助于故障转移,减少故障的停机.

<img src="E:\截图文件\快照复制的备份架构.png" style="zoom:67%;" />

