### HyperLogLog

#### 基数计数的方式

基数计数用于统计一个集合中不重复的元素个数.

##### 使用Bitmap计数

使用bitmap去重的特点进行存储.

##### 线性计数法LC

计算散列后的值表现在bitmap上, 可以通过bitmap中0的数目估计元素个数.

##### 对数计数法`LLC`

散列结果生成一个固定长度的二进制串, 散列结果每一位互相独立, 其实就是n次伯努利实验. 通过伯努利实验的值来估计基数值.

##### 自适应计数

LC和LLC的结合, 根据基数的量级选择使用哪种算法. 

##### 超对数计数

基于LLC的, 使用调和平均数替代算数平均数



#### Redis关于HyperLogLog的实现

#### HLL的结构

```c++
struct hllhdr{
    char magic[4];
    uint8_t encoding; // 编码方式
    uint8_t notused[3]; // 保留字段
    uint8_t card[8]; // 缓存基数 
    // HLL数据部分存储
    uint8_t registers[];
}
```

`Redis`使用card来表示最新的计算结果, card 最高位用来表示剩下的63位数据是否有效. 

#### 编码方式

##### 稀疏编码

将数据分散在16384个组中, 将重复的分组计数值进行压缩成操作码. 稀疏编码使用三种操作码 对register中数据进行编码.

分别是`ZERO`,`XZERO`和`VAL`.

##### 密集编码

由稀疏编码转换而来, 存储在16384个组中. 每个组占用6位, 密集编码就是16384个6 bit的位图组成的

##### Raw编码(内部编码)

内部编码使用8位存储, 内部编码没有位运算, 每次循环读取8个字节的数据. 

#### 编码转换

当稀疏编码(VAL存储格式)存储超出限制(32), 或者稀疏编码总长度超过设置的阈值, 会触发编码的转换.



