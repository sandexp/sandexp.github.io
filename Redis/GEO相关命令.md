### GEO

#### Z阶曲线

Z阶曲线使用x,y两轴, 将二维空间转换为一个连续的曲线.

这个曲线存在如下特点:

1. 相同前缀越多, 两个位置越相邻
2. 已知一个数字代表的区域可以方便的计算所属区域

#### `geohash`算法

##### `geohash`的计算方法

客户端在接受`geoadd`指令之后, 会对经纬度进行`geohash-int`编码, 返回int值作为`zadd`操作的score值. 

例如:

```bash
$ geoadd Beijing 116.312621 40.058918 "xierqi"
```

计算之后会得到一个二进制序列, 通过每五个元素一组, 替换为`geoalphabet`中的值, 即可得到`Base32`编码之后的字符串.

#### `geopos`进行经纬度的查询

通过`geohash-int`编码转换一个整数值, 然后在`zset`中查找分值中对应于这个整数的经纬度.

#### `geodist`计算两点距离

采用`Haversine`计算`Redis`中距离, 这个公式主要用于计算球面上两点的距离. `Redis`主要是计算特定范围内坐标之间的距离, 误差是可以接受的. 

给定两个位置, 在`zset`中查找`score`值. 求出经纬度信息, 通过`Haversine`计算出距离.

#### `georadius/georadiusbymembe `查询范围元素

查询步骤:

1. 确定`geohash`的位数
2. 在指定位数下进行经纬度编码
3. 查找指定编码周围的8个编码
4. 从上述获取的9个编码中构造区间
5. 将每个区间转换为score的区间
6. 使用`zset`的范围查询进行查询
7. 计算出每个点的经纬度, 计算到指定经纬度的距离. 排除不在范围内的点.

