### 事务

Redis的事务中所有命令都会顺序执行, 事务执行过程中不会被其他客户端打断.

事务是一个原子操作, 要不全部执行, 要不全不执行.

#### 事务的基本使用

Redis使用`MUTLI`开启一个事务, 指令在执行之前会被防止到队列中, 只有遇到`EXEC`时候才会执行事务.

>  关于Redis事务半写AOF的问题
>
> 加载AOF时, 检查记录可以发现这条记录信息有问题, 汇报一个错误即可.



`DISCARD`用于放弃一个事务的执行, 这个指令会清空事务队列, 并修改事务相关的标记位.

#### 事务中错误的处理

假定事务在执行之前或者执行过程中遇到了错误. 

在Redis 2.6.5 之前, Redis 忽略了失败的命令，而执行成功的命令，这样不能保证事务的原子性.

在Redis 2.6.5 之后, Redis 在服务端会对错误的情况记录, 客户端执行事务的时候会自动放弃.

#### Redis关于乐观锁的实现

`WATCH`为Redis事务提供了CAS行为, 被`WATCH`指令监视的键一旦发生了修改, 则事务就会被放弃. (check and set).

#### Redis 脚本与事务

 Redis 中的脚本本身就是一种事务， 所以任何在事务里可以完成的事， 在脚本里面也能完成。 并且一般来说， 使用脚本要来得更简单，并且速度更快。