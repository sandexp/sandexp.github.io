#### AOF与RDB的区别

1. 执行效果

AOF文件是Redis执行过程中记录的操作记录，Redis启动的时候，只要对日志中的操作进行回放，就可以恢复状态机。理论上来说，AOF最多只会丢失一条修改的操作记录信息。

RDB保存的是Redis某一个时间点的快照信息，Redis启动时候，恢复的是最近一个RDB时刻的状态信息。

2. 执行过程

RDB 通过将文件的数据反序列化加载到内存中恢复状态机，AOF通过建立一个伪客户端，通过执行AOF指令恢复状态机。 

#### AOF执行流程

开启AOF功能之后, 每条命令执行完毕之后写入aof_buf中.

AOF最终会持久化到磁盘上, 写文件write函数执行，write函数执行之后会存储在内核的缓冲区。操作系统通过调用fsync将数据刷写到磁盘中。Redis通过appendfsync来控制fsync的频率.

+ `no`: 不执行fsync, 由操作系统刷盘。数据安全最低但是性能最高.
+ `always`: 每执行一次写入就会执行一次fsync，速度最低，但是最安全.
+ `everysec`: 每秒刷写一次，上述两种方案的折中.

#### AOF重写

AOF重写通过fork出一个子进程来执行，重写不会对原有文件进行任何修改和读取，子进程对所有数据库中所有的键各自生成一条相应的执行命令，最后将重写开始后父进程继续执行的命令进行回放，生成一个新的AOF文件.

##### AOF重写触发方式

AOF重写有两种触发方式：一种为通过配置自动触发，一种为手动执行bgrewriteaof命令显式触发。

##### 混合持久化

混合持久化指进行AOF重写时子进程将当前时间点的数据快照保存为RDB文件格式，而后将父进程累积命令保存为AOF格式。

加载时，首先会识别AOF文件是否以REDIS字符串开头，如果是，就按RDB格式加载，加载完RDB后继续按AOF格式加载剩余部分。

